name: Podman Build

on:
  workflow_call:
    inputs:
      registry_url:
        description: |
          The URL of the Docker registry where the image will be pushed.
        required: true
        type: string
      registry_cache_url:
        description: |
          The registry that the build cache will be stored.
        required: false
        type: string
      name:
        description: |
          The name of the Docker image to be built and pushed. This typically includes the repository name.
        required: true
        type: string
      dockerfile:
        description: |
          The path to the Dockerfile used for building the Docker image.
        type: string
        default: "./Dockerfile"
      cache:
        description: |
          Enables or disables caching for Docker builds. If enabled, Podman will use layer caching and the registry cache.
        type: boolean
        default: true
      push:
        description: |
          Controls whether the image should be pushed to the registry. If set to false, the image will only be built and not pushed.
        type: boolean
        default: false
      tag:
        description: |
          The tag to be used for the Docker image.
        default: ""
        type: string

    secrets:
      registry_username:
        description: |
          The username for authentication with the Docker registry.
        required: true
      registry_password:
        description: |
          The password for authentication with the Docker registry.
        required: true

jobs:
  build:
    runs-on: ${{ vars.RUNNER }}
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up authentication
        run: |
          mkdir -p $HOME/.config/containers
          cat <<EOF > $HOME/.config/containers/auth.json
          {
            "auths": {
              "${{ inputs.registry_url }}": {
                "username": "${{ secrets.registry_username }}",
                "password": "${{ secrets.registry_password }}"
              },
              "${{ inputs.registry_cache_url }}": {
                "username": "${{ secrets.registry_username }}",
                "password": "${{ secrets.registry_password }}"
              }
            }
          }
          EOF
          chmod 600 $HOME/.config/containers/auth.json

      - name: Build and push image
        run: |
          set -euxo pipefail

          IMAGE_REF="${{ inputs.registry_url }}/${{ inputs.name }}:${{ inputs.tag }}"

          # Optional cache: pre-pull cache image to seed local layers
          if [ "${{ inputs.cache }}" = "true" ] && [ -n "${{ inputs.registry_cache_url }}" ]; then
            CACHE_REPO="${{ inputs.registry_cache_url }}/${{ inputs.name }}-cache:latest"
            echo "Attempting to pre-pull cache image: $CACHE_REPO"
            podman pull "$CACHE_REPO" || echo "Cache image not available yet"
          fi

          echo "Building image with Podman..."
          podman build --layers -f "${{ inputs.dockerfile }}" -t "$IMAGE_REF" .

          if [ "${{ inputs.push }}" = "true" ]; then
            echo "Pushing $IMAGE_REF"
            podman push "$IMAGE_REF"
            # Optionally update cache tag to latest for future builds
            if [ "${{ inputs.cache }}" = "true" ] && [ -n "${{ inputs.registry_cache_url }}" ]; then
              CACHE_REPO="${{ inputs.registry_cache_url }}/${{ inputs.name }}-cache:latest"
              echo "Updating cache reference: $CACHE_REPO"
              podman tag "$IMAGE_REF" "$CACHE_REPO" || true
              podman push "$CACHE_REPO" || true
            fi
          fi
