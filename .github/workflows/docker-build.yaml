name: Kaniko Build

on:
  workflow_call:
    inputs:
      registry_url:
        required: true
        type: string
      registry_cache_url:
        required: false
        type: string
      name:
        required: true
        type: string
      dockerfile:
        type: string
        default: "./Dockerfile"
      cache:
        type: boolean
        default: true
      push:
        type: boolean
        default: false
      tag:
        default: ""
        type: string
    secrets:
      registry_username:
        required: true
      registry_password:
        required: true

jobs:
  build:
    runs-on: ${{ vars.RUNNER }}
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build with buildkit
        env:
          REGISTRY_URL: ${{ inputs.registry_url }}
          REGISTRY_USERNAME: ${{ secrets.registry_username }}
          REGISTRY_PASSWORD: ${{ secrets.registry_password }}
          IMAGE_NAME: ${{ inputs.name }}
          IMAGE_TAG: ${{ inputs.tag }}
          DOCKERFILE: ${{ inputs.dockerfile }}
          CACHE_ENABLED: ${{ inputs.cache }}
          CACHE_REPO: ${{ inputs.registry_cache_url }}
          PUSH_ENABLED: ${{ inputs.push }}
        run: |
          set -euo pipefail

          IMAGE_REF="${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}"
          CACHE_IMAGE="${CACHE_REPO:+${CACHE_REPO}/cache}"

          echo "Building: ${IMAGE_REF}"

          # Create docker config for buildkit
          mkdir -p ~/.docker
          cat > ~/.docker/config.json <<EOF
          {
            "auths": {
              "${REGISTRY_URL}": {
                "username": "${REGISTRY_USERNAME}",
                "password": "${REGISTRY_PASSWORD}"
              }
            }
          }
          EOF

          # Build cache flags
          CACHE_FLAGS=""
          if [ "${CACHE_ENABLED}" = "true" ] && [ -n "${CACHE_IMAGE}" ]; then
            CACHE_FLAGS="--export-cache type=registry,ref=${CACHE_IMAGE},mode=max --import-cache type=registry,ref=${CACHE_IMAGE}"
          fi

          # Build directly with buildctl-daemonless
          export DOCKER_CONFIG=~/.docker
          export BUILDKITD_FLAGS="--oci-worker-no-process-sandbox"
          
          buildctl-daemonless.sh build \
            --frontend dockerfile.v0 \
            --local context=. \
            --local dockerfile=. \
            --opt filename=${DOCKERFILE} \
            --output type=image,name=${IMAGE_REF},push=${PUSH_ENABLED} \
            ${CACHE_FLAGS}
          
          echo "Build complete!"
