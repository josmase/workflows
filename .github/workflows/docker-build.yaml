name: Kaniko Build

on:
  workflow_call:
    inputs:
      registry_url:
        description: |
          The URL of the Docker registry where the image will be pushed.
        required: true
        type: string
      registry_cache_url:
        description: |
          The registry that the build cache will be stored.
        required: false
        type: string
      name:
        description: |
          The name of the Docker image to be built and pushed. This typically includes the repository name.
        required: true
        type: string
      dockerfile:
        description: |
          The path to the Dockerfile used for building the Docker image.
        type: string
        default: "./Dockerfile"
      cache:
        description: |
          Enables or disables caching for Docker builds. If enabled, Kaniko will use layer caching and the registry cache.
        type: boolean
        default: true
      push:
        description: |
          Controls whether the image should be pushed to the registry. If set to false, the image will only be built and not pushed.
        type: boolean
        default: false
      tag:
        description: |
          The tag to be used for the Docker image.
        default: ""
        type: string

    secrets:
      registry_username:
        description: |
          The username for authentication with the Docker registry.
        required: true
      registry_password:
        description: |
          The password for authentication with the Docker registry.
        required: true

jobs:
  build:
    runs-on: ${{ vars.RUNNER }}
    permissions:
      contents: read
    container:
      image: gcr.io/kaniko-project/executor:v1.23.2
      options: |
        --dockerfile=${{ inputs.dockerfile }}
        --destination=${{ inputs.registry_url }}/${{ inputs.name }}:${{ inputs.tag }}
        --cache=${{ inputs.cache }}
        ${{ inputs.cache && format('--cache-repo={0}/cache', inputs.registry_cache_url) || '' }}
        ${{ inputs.push && '' || '--no-push' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Log build parameters
        run: |
          echo "Building image: ${{ inputs.registry_url }}/${{ inputs.name }}:${{ inputs.tag }}"
          echo "Dockerfile: ${{ inputs.dockerfile }}"
          echo "Cache enabled: ${{ inputs.cache }}"
          echo "Push enabled: ${{ inputs.push }}"
      
      - name: Create registry credentials
        env:
          REGISTRY_URL: ${{ inputs.registry_url }}
          REGISTRY_USERNAME: ${{ secrets.registry_username }}
          REGISTRY_PASSWORD: ${{ secrets.registry_password }}
        run: |
          # Kaniko hooks will use the injected env vars to build
          # The Job is automatically created by the container hooks
          # This step just ensures Kaniko has what it needs
          mkdir -p /.docker
          cat > /.docker/config.json <<EOF
          {
            "auths": {
              "${REGISTRY_URL}": {
                "username": "${REGISTRY_USERNAME}",
                "password": "${REGISTRY_PASSWORD}"
              }
            }
          }
          EOF
